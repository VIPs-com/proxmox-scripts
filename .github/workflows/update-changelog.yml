name: 📜 Auto Update CHANGELOG

on:
  push:
    branches: [main]
    paths:
      - 'scripts/proxmox-postinstall-aurora-luna.sh'
  workflow_dispatch:

jobs:
  changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: 🔄 Checkout do repositório
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ⚙️ Configurar Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: 📝 Atualizar CHANGELOG.md
      run: |
        TODAY=$(date +'%Y-%m-%d')

        # Cria o arquivo se não existir
        if [ ! -f CHANGELOG.md ]; then
          echo "# 📜 CHANGELOG - Proxmox Scripts" > CHANGELOG.md
          echo "" >> CHANGELOG.md
        fi

        # Verifica se já existe entrada hoje
        if grep -q "## [$TODAY]" CHANGELOG.md; then
          echo "✅ Entrada já existe para hoje. Nada a fazer."
          exit 0
        fi

        # Adiciona entrada no topo do arquivo
        TEMP_FILE=$(mktemp)
        {
          echo "## [$TODAY]"
          echo "- 📦 Script 'proxmox-postinstall-aurora-luna.sh' atualizado automaticamente"
          echo ""
          cat CHANGELOG.md
        } > "$TEMP_FILE" && mv "$TEMP_FILE" CHANGELOG.md

    - name: 🚀 Commit e Push
      run: |
        git add CHANGELOG.md
        git commit -m "📜 Auto-update CHANGELOG for $TODAY" || echo "ℹ️ Nenhuma mudança para commitar"
        git push origin main
